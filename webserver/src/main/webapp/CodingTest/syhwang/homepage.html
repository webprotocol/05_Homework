
<!DOCTYPE html><html class=''>
<head><script src='//production-assets.codepen.io/assets/editor/live/console_runner-5710c30fb566082d9fcb6e7d97ee7e3f2a326128c9f334a4231b6fd752b29965.js'></script><script src='//production-assets.codepen.io/assets/editor/live/events_runner-d5e4bf42585b8da8c18f7d963dbfc17cd66a79aa586c9448c4de8d6952ee9d97.js'></script><script src='//production-assets.codepen.io/assets/editor/live/css_live_reload_init-25d1423d5d6fb975e7d61832d2c061422a94963ca446583b965dfc5569147311.js'></script><meta charset='UTF-8'><meta name="robots" content="noindex"><link rel="shortcut icon" type="image/x-icon" href="//production-assets.codepen.io/assets/favicon/favicon-8ea04875e70c4b0bb41da869e81236e54394d63638a1ef12fa558a4a835f1164.ico" /><link rel="mask-icon" type="" href="//production-assets.codepen.io/assets/favicon/logo-pin-f2d2b6d2c61838f7e76325261b7195c27224080bc099486ddd6dccb469b8e8e6.svg" color="#111" /><link rel="canonical" href="http://codepen.io/anon/pen/PbOMjg" />

<link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css'>
<style class="cp-pen-styles">canvas {
  position: relative;
  top: 0;
  margin-left: 30px;
  z-index: -1;
}
canvas + canvas {
  opacity: 0.3;
  z-index: -2;
}
.desc {
  position: absolute;
  z-index: 10;
  left: 0;
  right: 0;
  bottom: 0;
  padding: 1em;
  font-size: 10px;
  color: #aaa;
  text-align: center;
}
.loading:before {
  position: absolute;
  top: 0;
  left: 0;
  padding: 1em;
  content: 'Loading...';
  color: #aaa;
  font-family: monospace;
}
</style></head><body>

<script src='//production-assets.codepen.io/assets/common/stopExecutionOnTimeout-58d22c749295bca52f487966e382a94a495ac103faca9206cbd160bdf8aedf2a.js'></script><script src='https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.0.3/pixi.min.js'></script>
<script>;(function(){

  // bracket [≠] square [⠝]
  var svgIcon = '<svg class="shaw__icon" width="222" height="284" viewBox="0 0 2223 2846"><path fill="#f4d198" d="M1040 436c46-.8 71.4 17.4 103 31l82 35 441 189c-3 6.2-3.7 9-2 16 28.7 21.2 64 26.6 102 41 32 12.2 62.6 27.5 89 46 70 49.6 122 125.5 156 211 16.7 42.4 23 95.4 40 136 21.3 52.2 85.3 136.6 72 214-9 50.5-31.4 75-57 107-19 23.4-52 45.2-43 95 14.7 82.3 57.8 139 89 205 10.8 23.4 22 46.7 32.8 70l10 32c17.8 28 85.5 81.5 64 130-15 34.3-48.4 58.2-84 72-17 4.4-34 8.8-51 13 5 15.5 9 29.5 16 42-5.6 6.8-11.3 13.4-17 20 1.4 58 36.5 119.5 4 164-14 19.4-35 26.6-54 41 9.7 12.6 21.5 23.3 28 39 30 72.4-52.2 154.4-82 196-17.7 25-36.7 64.3-64 79-52.3-6.2-104.6-12.6-157-19-130.8-26-259.5-41.8-381-76-82.6-23-166-43.7-243-74l-143-59c-.2-50-.5-100-1-150h-1c-23.5 1.4-47.2 2.8-71 4l-15 15c-13.7 10.2-32 17.4-52 21-90.8 17.2-202.2-74.8-249.8-112l-42-38c-11.4-1.6-22.7-3.2-34-5-33.6-7.2-99.3-17.8-115-41l-67-167-142-339 166-20c1.4-27.2 26.6-95.5 51-97l181 49 2-1c-.7-51.7 2-106.3 10-154 8.6-51.6 8-103.5 17-152l18-124c29.5-135.3 55.3-266.4 104-381 41.2-97.2 85.7-194 164-254 22.4-17.2 48.8-32.8 79-42l47-8z"/><path fill="#bf3d27" d="M1008 59v-8c14.8 4.4 23.6 20.4 35 29l65 43c8.4 6.3 26.4 24.8 40 21 9.7-5 8.2-22.2 8-34 15 7.2 32.2 21.3 49 24v-5c-4.4-15.4-4.7-33-7-51h6c88.8 27.2 209.3 5.2 297 22l52-2c32.2 7.3 66.3 35.3 97 47l52 17c3.5 5.7 7.2 11.3 11 17 8.2 6.3 16.5 12.7 25 19 58.6 30.8 113.8 60 168 93l24 10c10.6 7.4 11 22.2 20 31 13.2 9.3 26.5 18.7 40 28 31.5 25.4 72.8 84 89 124 14 35.8 12.7 100 3 139-23.3 92-85 195.2-150 244-3.5-3.3-6.8-6.6-10-10l-51-46-213 57-196 85c-41.2 18-84.3 36-122 58-26 15-49.5 34-83 41-54 11.2-111-6.6-161-7 8.6 61.2 25 132 52 179 8 14.2 41.8 81.8 39 101-12.7 85.2-70.4 125.8-122 172l7 137 7 101c12.5 77.8 10 156.3 24 229 9 48 13 94 25 137l8 34c8.6 16 90.4 62.3 111 75 79.6 49.7 164.7 96.8 254 136 38.3 17 84 48.6 126 58 18.4-23 38-43 54-70 6.2-14.6 12.5-29.2 19-44 6.3-10.5 67.2-41 82-50 61.3-37.3 124.7-70.7 196-99 34.2-13.5 75.3-29.6 121-23 4.5 10.4 9.2 20.8 14 31 10.6 34.2.8 70.2-12 94-31.2 1-63 14.8-89 23-82.7 26.3-167.3 58-214 120-23.7 31.4-44 88.3-13 128 18.2 23.8 53.3 24 83 11 21.6-9.4 40-30.8 59-39 18.4-7.8 80.2-5.5 99 0-2.6 28.8-3.4 61.8-3 94v47c-14 83.2-40 137-95 177-94.4 68.6-214.8 41.3-315 2-60.8-21.5-121.4-43.2-182-65-120.6-58-243.3-122.3-355-190-72.2-43.5-139.8-77-182-150-17.7-30.3-20-87-12-132l28-184 6-76c5.3-33.3 2.7-117-9-139l-62-67c-57-57-198.2-164.5-324-138-42.3 9-87.2 26.4-109 56-32 43.3-40.3 141.8-16 201 27.5 67.4 69.7 136 112 191l80 84 4 40c11.4 71.7-24.4 176.2-59 205-10.4-11.6-20.7-23.2-31-35-22.4-28-47.7-53.4-70-82-60.6-77-115.6-155-167-243-18-31-29.4-66-44-100l-83-196C88.7 1670 27.3 1539.8 0 1406v-138c0-155.8 32.6-292.3 91-391 16.3-27.6 37-57 62-76l29-17 52-44 22-17 62-96 14-46 35-86c29.3-66.6 70.2-123.8 113-177 23.6-29.4 57-46.7 87-70C627.8 201 717.3 93.4 730 0h4c30 13 74.3 15.3 109 21h27c19.6 5.2 33.4 22.5 56 28l1-13h8l-1-8 26 11 3-4c10.6 9.8 27 22.4 45 24zm917 68h2-2zm2 1h2-2zm58 47c1.5 1.7 3.2 3.3 5 5l-3-2c-3.2-2-1.2-.3-2-3z"/></svg>';

  document.head.insertAdjacentHTML('beforeend','<style>.shaw { display: block; position: absolute; position: fixed; z-index: 9999; bottom: 5px; right: 5px; font-size: 10px; color: #c03b27; text-decoration: none; padding: 10px; border-radius: 50%; opacity: 0.4; transform-origin: 100% 100%; transition: all 300ms ease-in-out; } .shaw > * { transition: inherit; } .shaw:hover { opacity: 1; background: rgba(255,255,255,0.9); } .shaw__icon, .shaw__title { display: inline-block; vertical-align: middle; } .shaw__icon { width: 24px; height: 24px; position: relative; z-index: 1; } .shaw__title {  white-space: nowrap; opacity: 0; padding-right: 10px; transform: translateX(100%); } .shaw:hover .shaw__title { transform: scale(1); opacity: 1; } .shaw:hover .shaw__icon { transform: scale(1.4); } </style>'); // .shaw__title { position: absolute; right: 100%; top: 50%; margin-top: -0.5em;width: fit-content; position: absolute; right: 100%; margin-right: 10px; }

  var a = document.createElement('a');
  a.setAttribute('href','http://codepen.io/shshaw');
  a.setAttribute('target','_blank');
  a.className = 'shaw';
  a.innerHTML = svgIcon;
  a.onclick = function(){
    if ( ga ) {
      var url = this.getAttribute('href');
      ga('send', 'event', 'shawhead', 'click', url, {
        'transport': 'beacon',
        'hitCallback': function(){ console.log('callback!');window.open(url); }
      });
      return false;
    }
  };

  document.body.appendChild(a);

  //document.body.insertAdjacentHTML('beforeend','<a href="http://codepen.io/shshaw" target="_blank" class="shaw">'+svgIcon+'</a>');

})();


(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-6412794-6', 'auto');
ga('send', 'pageview');</script><script src='https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.1/dat.gui.min.js'></script>
<script>'use strict';

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

console.clear();

var mesh = undefined;
var cloth = undefined;
var spacingX = 5;
var spacingY = 5;
var accuracy = 1;

var opts = {
  image: 'http://lovedeer118.dothome.co.kr/img/Hepburn.png',
  gravity: 200,
  friction: 0.99,
  bounce: 0.3,
  pointsX: 20,
  pointsY: 22,
  renderCloth: true,
  mouseInfluence: 35,
  pinCorners: true,
  randomImage: function randomImage() {
    this.image = 'https://unsplash.it/400/400?image=' + Math.floor(Math.random() * 1100);
    loadTexture();
  }
};

var gui = new dat.GUI();
gui.closed = window.innerWidth < 600;
var renderCloth = gui.add(opts, 'renderCloth');

var image = gui.add(opts, 'image', {
  Face: 'http://brokensquare.com/Code/assets/face.png',
  Water: 'https://unsplash.it/400/400?image=1053',
  YellowCurtain: 'https://unsplash.it/400/400?image=855',
  Tunnel: 'https://unsplash.it/400/400?image=137'
});
image.onChange(loadTexture);

var random = gui.add(opts, 'randomImage');
var influence = gui.add(opts, 'mouseInfluence', 0, 200).step(1);
var gravity = gui.add(opts, 'gravity', 0, 1000).step(20);
var friction = gui.add(opts, 'friction', 0.5, 1).step(0.005);
var bounce = gui.add(opts, 'bounce', 0, 2).step(0.1);

var pin = gui.add(opts, 'pinCorners');
pin.onChange(loadTexture);

var canvas = document.createElement('canvas');
var ctx = canvas.getContext('2d');
document.body.appendChild(canvas);

ctx.strokeStyle = '#555';

var mouse = {

  down: false,
  x: 0,
  y: 0,
  px: 0,
  py: 1
};

/*////////////////////////////////////////*/

var stage = new PIXI.Container();
var renderer = PIXI.autoDetectRenderer(window.innerWidth, window.innerHeight, { transparent: true });

document.body.insertBefore(renderer.view, canvas);
renderer.render(stage);

canvas.width = renderer.width;
canvas.height = renderer.height;

/*////////////////////////////////////////*/

function loadTexture() {

  console.log('loading texture', opts.image);

  document.body.className = 'loading';

  var texture = new PIXI.Texture.fromImage(opts.image);
  if (!texture.requiresUpdate) {
    texture.update();
  }

  texture.on('error', function () {
    console.error('AGH!');
  });

  texture.on('update', function () {
    document.body.className = '';

    console.log('texture loaded');

    if (mesh) {
      stage.removeChild(mesh);
    }

    mesh = new PIXI.mesh.Plane(this, opts.pointsX, opts.pointsY);
    mesh.width = this.width;
    mesh.height = this.height;

    spacingX = mesh.width / (opts.pointsX - 1);
    spacingY = mesh.height / (opts.pointsY - 1);

    cloth = new Cloth(opts.pointsX - 1, opts.pointsY - 1, !opts.pinCorners);

    stage.addChild(mesh);
  });
}

loadTexture(opts.image);

;(function update() {
  requestAnimationFrame(update);
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (cloth) {
    cloth.update(0.016);
  }
  renderer.render(stage);
})(0);

/*////////////////////////////////////////*/

var Point = function () {
  function Point(x, y) {
    _classCallCheck(this, Point);

    this.x = x;
    this.y = y;
    this.px = x;
    this.py = y;
    this.vx = 0;
    this.vy = 0;
    this.pinX = null;
    this.pinY = null;

    this.constraints = [];
  }

  Point.prototype.update = function update(delta) {
    if (this.pinX && this.pinY) return this;

    if (mouse.down) {
      var dx = this.x - mouse.x;
      var dy = this.y - mouse.y;
      var dist = Math.sqrt(dx * dx + dy * dy);

      if (mouse.button === 1 && dist < opts.mouseInfluence) {
        this.px = this.x - (mouse.x - mouse.px);
        this.py = this.y - (mouse.y - mouse.py);
      } else if (dist < mouse.cut) {
        this.constraints = [];
      }
    }

    this.addForce(0, opts.gravity);

    var nx = this.x + (this.x - this.px) * opts.friction + this.vx * delta;
    var ny = this.y + (this.y - this.py) * opts.friction + this.vy * delta;

    this.px = this.x;
    this.py = this.y;

    this.x = nx;
    this.y = ny;

    this.vy = this.vx = 0;

    if (this.x >= canvas.width) {
      this.px = canvas.width + (canvas.width - this.px) * opts.bounce;
      this.x = canvas.width;
    } else if (this.x <= 0) {
      this.px *= -1 * opts.bounce;
      this.x = 0;
    }

    if (this.y >= canvas.height) {
      this.py = canvas.height + (canvas.height - this.py) * opts.bounce;
      this.y = canvas.height;
    } else if (this.y <= 0) {
      this.py *= -1 * opts.bounce;
      this.y = 0;
    }

    return this;
  };

  Point.prototype.draw = function draw() {
    var i = this.constraints.length;
    while (i--) {
      this.constraints[i].draw();
    }
  };

  Point.prototype.resolve = function resolve() {
    if (this.pinX && this.pinY) {
      this.x = this.pinX;
      this.y = this.pinY;
      return;
    }

    this.constraints.forEach(function (constraint) {
      return constraint.resolve();
    });
  };

  Point.prototype.attach = function attach(point) {
    this.constraints.push(new Constraint(this, point));
  };

  Point.prototype.free = function free(constraint) {
    this.constraints.splice(this.constraints.indexOf(constraint), 1);
  };

  Point.prototype.addForce = function addForce(x, y) {
    this.vx += x;
    this.vy += y;
  };

  Point.prototype.pin = function pin(pinx, piny) {
    this.pinX = pinx;
    this.pinY = piny;
  };

  Point.prototype.unpin = function unpin() {
    this.pinX = null;
    this.pinY = null;
  };

  return Point;
}();

/*////////////////////////////////////////*/

var Constraint = function () {
  function Constraint(p1, p2, length) {
    _classCallCheck(this, Constraint);

    this.p1 = p1;
    this.p2 = p2;
    this.length = length || spacingX;
  }

  Constraint.prototype.resolve = function resolve() {
    var dx = this.p1.x - this.p2.x;
    var dy = this.p1.y - this.p2.y;
    var dist = Math.sqrt(dx * dx + dy * dy);

    if (dist < this.length) return;

    var diff = (this.length - dist) / dist;

    //if (dist > tearDist) this.p1.free(this)

    var mul = diff * 0.5 * (1 - this.length / dist);

    var px = dx * mul;
    var py = dy * mul;

    !this.p1.pinX && (this.p1.x += px);
    !this.p1.pinY && (this.p1.y += py);
    !this.p2.pinX && (this.p2.x -= px);
    !this.p2.pinY && (this.p2.y -= py);

    return this;
  };

  Constraint.prototype.draw = function draw() {
    ctx.moveTo(this.p1.x, this.p1.y);
    ctx.lineTo(this.p2.x, this.p2.y);
  };

  return Constraint;
}();

/*////////////////////////////////////////*/

var count = 0;

var Cloth = function () {
  function Cloth(clothX, clothY, free) {
    _classCallCheck(this, Cloth);

    this.points = [];

    var startX = canvas.width / 2 - clothX * spacingX / 2;
    var startY = canvas.height * 0.1;

    for (var y = 0; y <= clothY; y++) {
      for (var x = 0; x <= clothX; x++) {
        var point = new Point(startX + x * spacingX, 20 + y * spacingY + startY);
        !free && y === 0 && point.pin(point.x, point.y);
        x !== 0 && point.attach(this.points[this.points.length - 1]);
        y !== 0 && point.attach(this.points[x + (y - 1) * (clothX + 1)]);

        this.points.push(point);
      }
    }
  }

  Cloth.prototype.update = function update(delta) {
    var i = accuracy;

    while (i--) {
      this.points.forEach(function (point) {
        point.resolve();
      });
    }

    ctx.beginPath();

    this.points.forEach(function (point, i) {
      point.update(delta * delta);

      if (opts.renderCloth) {
        point.draw();
      }

      if (mesh) {
        i *= 2;
        mesh.vertices[i] = point.x;
        mesh.vertices[i + 1] = point.y;
      }
    });

    ctx.stroke();
  };

  return Cloth;
}();

function pointerMove(e) {
  var pointer = e.touches ? e.touches[0] : e;
  mouse.px = mouse.x || pointer.clientX;
  mouse.py = mouse.y || pointer.clientY;
  mouse.x = pointer.clientX;
  mouse.y = pointer.clientY;
}

function pointerDown(e) {
  mouse.down = true;
  mouse.button = 1;
  pointerMove(e);
}

function pointerUp(e) {
  mouse.down = false;
  mouse.px = null;
  mouse.py = null;
  console.log('pointer up');
}

document.body.addEventListener('mousedown', pointerDown);
document.body.addEventListener('touchstart', pointerDown);

document.body.addEventListener('mousemove', pointerMove);
document.body.addEventListener('touchmove', pointerMove);

document.body.addEventListener('mouseup', pointerUp);
document.body.addEventListener('touchend', pointerUp);
document.body.addEventListener('mouseleave', pointerUp);
//# sourceURL=pen.js
</script>
</body></html>